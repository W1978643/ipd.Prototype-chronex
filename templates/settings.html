<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ==== Document Meta & Resources ==== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Chronex</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- ==== Cosmic Background ==== -->
    <div class="cosmic-background"></div>
    <div class="stars-decoration"></div>

    <!-- ==== Site Header ==== -->
    <header class="site-header">
        <a href="{{ url_for('show_dashboard') }}" class="site-logo">Chronex</a>
        <nav class="navigation-menu">
            <a href="{{ url_for('show_dashboard') }}" class="navigation-link">Dashboard</a>
            <a href="{{ url_for('show_tasks_page') }}" class="navigation-link">Tasks</a>
            <a href="{{ url_for('show_notes_page') }}" class="navigation-link">Notes</a>
            <a href="{{ url_for('show_focus_page') }}" class="navigation-link">Focus</a>
            <a href="{{ url_for('show_budget_page') }}" class="navigation-link">Budget</a>
            <a href="{{ url_for('show_achievements_page') }}" class="navigation-link">Achievements</a>
        </nav>
        <div class="header-right-section">
            <span class="logged-in-username">{{ current_user.username }}</span>
            <a href="{{ url_for('show_settings_page') }}" class="navigation-link active">Settings</a>  <!-- Current page -->
            <a href="{{ url_for('handle_logout') }}" class="navigation-link">Logout</a>
        </div>
    </header>

    <!-- ==== Main Content ==== -->
    <main class="page-content">
        <h1 class="page-title">Settings</h1>
        <p class="page-subtitle">Manage your account and preferences</p>

        <!-- ==== Profile Section ==== -->
        <!-- 
            Displays user profile information (read-only)
            Edit Email button opens modal for updating email
        -->
        <div class="settings-group">
            <div class="settings-group-heading">Profile</div>
            
            <!-- Username Row (not editable) -->
            <div class="settings-item-row">
                <span class="settings-item-label">Username</span>
                <span class="settings-item-value">{{ current_user.username }}</span>
            </div>
            
            <!-- Username Row (Capitalized) -->
            <div class="settings-item-row">
                <span class="settings-item-label">Display Name</span>
                <span class="settings-item-value">{{ current_user.username|capitalize }}</span>
            </div>
            
            <!-- Email Row - shows 'Not set' if null -->
            <div class="settings-item-row">
                <span class="settings-item-label">Email</span>
                <span class="settings-item-value">{{ current_user.email or 'Not set' }}</span>
            </div>
            
            <!-- Member Since Row - formatted date -->
            <div class="settings-item-row">
                <span class="settings-item-label">Member Since</span>
                <span class="settings-item-value">{{ current_user.account_created_at.strftime('%d %B %Y') }}</span>
            </div>
            
            <!-- Edit Email Button -->
            <button class="button button-secondary margin-top-small" onclick="showEditProfileModal()">Edit Email</button>
        </div>

        <!-- ==== Statistics Section ==== -->
        <!-- 
            Read-only display of user activity statistics
            Data aggregated server-side from database
        -->
        <div class="settings-group">
            <div class="settings-group-heading">Statistics</div>
            
            <!-- Total Tasks Count -->
            <div class="settings-item-row">
                <span class="settings-item-label">Total Tasks Created</span>
                <span class="settings-item-value">{{ user_statistics.tasks }}</span>
            </div>
            
            <!-- Total Notes Count -->
            <div class="settings-item-row">
                <span class="settings-item-label">Total Notes Saved</span>
                <span class="settings-item-value">{{ user_statistics.notes }}</span>
            </div>
            
            <!-- Focus Points Total -->
            <div class="settings-item-row">
                <span class="settings-item-label">Focus Points Earned</span>
                <span class="settings-item-value">{{ user_statistics.focus_points }}</span>
            </div>
        </div>

        <!-- ==== Security Section ==== -->
        <!-- Password management -->
        <div class="settings-group">
            <div class="settings-group-heading">Security</div>
            
            <!-- Password Display (masked) -->
            <div class="settings-item-row">
                <span class="settings-item-label">Password</span>
                <span class="settings-item-value">••••••••</span>
            </div>
            
            <!-- Change Password Button -->
            <button class="button button-secondary margin-top-small" onclick="showChangePasswordModal()">Change Password</button>
        </div>

        <!-- ==== Danger Zone Section ==== -->
        <!-- 
            Account deletion with red warning styling
            Requires password confirmation for security
        -->
        <div class="settings-group" style="border-color: var(--color-danger);">
            <div class="settings-group-heading" style="color: var(--color-danger);">Danger Zone</div>
            <p class="text-faded" style="margin-bottom: 16px;">Once you delete your account, there is no going back. Please be certain.</p>
            <button class="button button-danger" onclick="showDeleteAccountModal()">Delete Account</button>
        </div>
    </main>

    <!-- ==== Edit Profile Modal ==== -->
    <!-- 
        Update user email address
        Email is optional - can be left blank to remove
    -->
    <div class="modal-backdrop" id="editProfileModal">
        <div class="modal-window">
            <div class="modal-heading">Edit Email</div>
            
            <form action="{{ url_for('handle_update_profile') }}" method="POST">
                <!-- Email Input - Pre-filled with current email if exists -->
                <div class="input-group">
                    <label class="input-label">Email (optional)</label>
                    <input type="email" name="email" class="text-input" placeholder="Enter your email" value="{{ current_user.email or '' }}">
                </div>
                
                <p class="text-faded" style="font-size: 0.85rem; margin-bottom: 16px;">Leave blank to remove email from your account.</p>
                
                <!-- Modal Action Buttons -->
                <div class="modal-buttons">
                    <button type="button" class="button button-secondary" onclick="hideEditProfileModal()">Cancel</button>
                    <button type="submit" class="button button-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==== Change Password Modal ==== -->
    <!-- 
        Requires current password for verification
        New password must be entered twice for confirmation
    -->
    <div class="modal-backdrop" id="changePasswordModal">
        <div class="modal-window">
            <div class="modal-heading">Change Password</div>
            
            <form action="{{ url_for('handle_change_password') }}" method="POST">
                <!-- Current Password (for verification) -->
                <div class="input-group">
                    <label class="input-label">Current Password</label>
                    <input type="password" name="current_password" class="text-input" placeholder="Enter current password" required>
                </div>
                
                <!-- New Password -->
                <div class="input-group">
                    <label class="input-label">New Password</label>
                    <input type="password" name="new_password" class="text-input" placeholder="Enter new password" required>
                </div>
                
                <!-- Confirm New Password -->
                <div class="input-group">
                    <label class="input-label">Confirm New Password</label>
                    <input type="password" name="confirm_password" class="text-input" placeholder="Confirm new password" required>
                </div>
                
                <!-- Modal Action Buttons -->
                <div class="modal-buttons">
                    <button type="button" class="button button-secondary" onclick="hideChangePasswordModal()">Cancel</button>
                    <button type="submit" class="button button-primary">Update Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==== Delete Account Modal ==== -->
    <!-- 
        Destructive action - requires password confirmation
        Red styling indicates danger
        All user data will be permanently deleted
    -->
    <div class="modal-backdrop" id="deleteAccountModal">
        <div class="modal-window">
            <div class="modal-heading" style="color: var(--color-danger);">Delete Account</div>
            <p class="text-faded margin-bottom-medium">This action cannot be undone. All your tasks, notes, and data will be permanently deleted.</p>
            
            <form action="{{ url_for('handle_delete_account') }}" method="POST">
                <!-- Password Confirmation -->
                <div class="input-group">
                    <label class="input-label">Enter your password to confirm</label>
                    <input type="password" name="password" class="text-input" placeholder="Your password" required>
                </div>
                
                <!-- Modal Action Buttons -->
                <div class="modal-buttons">
                    <button type="button" class="button button-secondary" onclick="hideDeleteAccountModal()">Cancel</button>
                    <button type="submit" class="button button-danger">Delete My Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==== Flash Messages ==== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="toast-notification {{ category }}" id="notificationToast">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ==== JavaScript ==== -->
    <script>
        // ==========================================
        //   PROFILE MODAL FUNCTIONS
        // ==========================================

        /**
         * Show the edit profile (email) modal
         */
        function showEditProfileModal() {
            document.getElementById('editProfileModal').classList.add('active');
        }

        /**
         * Hide the edit profile modal
         */
        function hideEditProfileModal() {
            document.getElementById('editProfileModal').classList.remove('active');
        }

        // ==========================================
        //   PASSWORD MODAL FUNCTIONS
        // ==========================================

        /**
         * Show the change password modal
         */
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('active');
        }

        /**
         * Hide the change password modal
         */
        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        // ==========================================
        //   DELETE ACCOUNT MODAL FUNCTIONS
        // ==========================================

        /**
         * Show the delete account confirmation modal
         */
        function showDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.add('active');
        }

        /**
         * Hide the delete account modal
         */
        function hideDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.remove('active');
        }

        // ==========================================
        //   EVENT LISTENERS
        // ==========================================

        // Close modals when clicking backdrop (outside modal content)
        document.getElementById('editProfileModal').addEventListener('click', function(clickEvent) {
            if (clickEvent.target === this) hideEditProfileModal();
        });

        document.getElementById('changePasswordModal').addEventListener('click', function(clickEvent) {
            if (clickEvent.target === this) hideChangePasswordModal();
        });

        document.getElementById('deleteAccountModal').addEventListener('click', function(clickEvent) {
            if (clickEvent.target === this) hideDeleteAccountModal();
        });

        // ==========================================
        //   TOAST NOTIFICATION
        // ==========================================

        const toastElement = document.getElementById('notificationToast');
        if (toastElement) {
            setTimeout(() => toastElement.classList.add('show'), 100);
            setTimeout(() => toastElement.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
