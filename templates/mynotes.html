<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ==== Document Meta & Resources ==== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Notes - Chronex</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- ==== Cosmic Background ==== -->
    <div class="cosmic-background"></div>
    <div class="stars-decoration"></div>

    <!-- ==== Site Header ==== -->
    <header class="site-header">
        <a href="{{ url_for('show_dashboard') }}" class="site-logo">Chronex</a>
        <nav class="navigation-menu">
            <a href="{{ url_for('show_dashboard') }}" class="navigation-link">Dashboard</a>
            <a href="{{ url_for('show_tasks_page') }}" class="navigation-link">Tasks</a>
            <a href="{{ url_for('show_notes_page') }}" class="navigation-link active">Notes</a>  <!-- Current page -->
            <a href="{{ url_for('show_focus_page') }}" class="navigation-link">Focus</a>
            <a href="{{ url_for('show_budget_page') }}" class="navigation-link">Budget</a>
            <a href="{{ url_for('show_achievements_page') }}" class="navigation-link">Achievements</a>
        </nav>
        <div class="header-right-section">
            <span class="logged-in-username">{{ current_user.username }}</span>
            <a href="{{ url_for('show_settings_page') }}" class="navigation-link">Settings</a>
            <a href="{{ url_for('handle_logout') }}" class="navigation-link">Logout</a>
        </div>
    </header>

    <!-- ==== Main Content ==== -->
    <main class="page-content">
        <!-- Page Header with New Note Button -->
        <div class="notes-page-header">
            <div>
                <h1 class="page-title">My Notes</h1>
                <p class="page-subtitle">Keep track of your thoughts and ideas</p>
            </div>
            <button class="button button-primary" onclick="showCreateNoteModal()">New Note</button>
        </div>

        <!-- ==== Notes Grid ==== -->
        <!-- 
            Responsive card layout using CSS Grid
            Auto-fills columns based on available width (min 250px per card)
        -->
        <div class="notes-card-grid">
            {% if user_notes %}
                <!-- Loop through user's notes from server -->
                {% for note in user_notes %}
                <!-- 
                    Note Preview Card
                    Clicking opens edit modal with note data
                    Uses backticks for content to preserve line breaks
                -->
                <div class="note-preview-card" onclick="showEditNoteModal({{ note.id }}, '{{ note.note_title }}', `{{ note.note_content }}`)">
                    <!-- Note Title - defaults to 'Untitled' if empty -->
                    <div class="note-card-title">{{ note.note_title or 'Untitled' }}</div>
                    
                    <!-- Content Preview - first 150 characters with ellipsis -->
                    <div class="note-content-preview">{{ note.note_content[:150] }}{{ '...' if note.note_content|length > 150 else '' }}</div>
                    
                    <!-- Last Modified Timestamp -->
                    <div class="note-last-updated">{{ note.last_modified_at }}</div>
                </div>
                {% endfor %}
            {% else %}
                <!-- ==== Empty State ==== -->
                <!-- Displayed when user has no notes -->
                <div class="empty-state-message" style="grid-column: 1 / -1;">  <!-- Span full grid width -->
                    <div class="empty-state-heading">No notes yet</div>
                    <p class="text-faded">Create your first note to get started</p>
                    <button class="button button-primary margin-top-small" onclick="showCreateNoteModal()">Create Note</button>
                </div>
            {% endif %}
        </div>
    </main>

    <!-- ==== Create/Edit Note Modal ==== -->
    <!-- 
        Reusable modal for both creating new notes and editing existing ones
        Form action URL changed dynamically by JavaScript
        Delete button only visible when editing (not creating)
    -->
    <div class="modal-backdrop" id="noteEditModal">
        <div class="modal-window" style="max-width: 600px;">  <!-- Wider modal for note content -->
            <div class="modal-heading" id="noteModalHeading">New Note</div>
            
            <form id="noteDetailsForm" action="{{ url_for('handle_add_note') }}" method="POST">
                <!-- Hidden field stores note ID when editing -->
                <input type="hidden" name="note_id" id="noteIdHidden" value="">
                
                <!-- Note Title Input -->
                <div class="input-group">
                    <label class="input-label">Title</label>
                    <input type="text" name="title" id="noteTitleInput" class="text-input" placeholder="Note title">
                </div>
                
                <!-- Note Content Textarea -->
                <div class="input-group">
                    <label class="input-label">Content</label>
                    <textarea name="content" id="noteContentTextarea" class="text-area" placeholder="Write your note here..." rows="8" required></textarea>
                </div>
                
                <!-- Modal Action Buttons -->
                <div class="modal-buttons">
                    <button type="button" class="button button-secondary" onclick="hideNoteModal()">Cancel</button>
                    <!-- Delete button - hidden for new notes, shown when editing -->
                    <button type="button" class="button button-danger" id="deleteNoteButton" onclick="confirmDeleteNote()" style="display:none;">Delete</button>
                    <button type="submit" class="button button-primary">Save Note</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==== Flash Messages ==== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="toast-notification {{ category }}" id="notificationToast">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ==== JavaScript ==== -->
    <script>
        // ==========================================
        //   STATE VARIABLES
        // ==========================================

        // Track which note is currently being edited (null when creating new)
        let editingNoteId = null;

        // ==========================================
        //   CREATE NOTE FUNCTIONS
        // ==========================================

        /**
         * Show modal for creating a new note
         * Clears all fields and sets form action to add endpoint
         */
        function showCreateNoteModal() {
            editingNoteId = null;  // Clear editing state
            
            // Update modal for "create" mode
            document.getElementById('noteModalHeading').textContent = 'New Note';
            document.getElementById('noteIdHidden').value = '';
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentTextarea').value = '';
            document.getElementById('deleteNoteButton').style.display = 'none';  // Hide delete button
            document.getElementById('noteDetailsForm').action = '{{ url_for("handle_add_note") }}';
            
            // Show modal
            document.getElementById('noteEditModal').classList.add('active');
        }

        // ==========================================
        //   EDIT NOTE FUNCTIONS
        // ==========================================

        /**
         * Show modal pre-filled for editing an existing note
         * @param {number} noteId - Note database ID
         * @param {string} noteTitle - Current note title
         * @param {string} noteContent - Current note content
         */
        function showEditNoteModal(noteId, noteTitle, noteContent) {
            editingNoteId = noteId;  // Store for delete function
            
            // Update modal for "edit" mode
            document.getElementById('noteModalHeading').textContent = 'Edit Note';
            document.getElementById('noteIdHidden').value = noteId;
            document.getElementById('noteTitleInput').value = noteTitle;
            document.getElementById('noteContentTextarea').value = noteContent;
            document.getElementById('deleteNoteButton').style.display = 'inline-block';  // Show delete button
            document.getElementById('noteDetailsForm').action = '{{ url_for("handle_update_note") }}';
            
            // Show modal
            document.getElementById('noteEditModal').classList.add('active');
        }

        /**
         * Hide the note modal
         */
        function hideNoteModal() {
            document.getElementById('noteEditModal').classList.remove('active');
        }

        // ==========================================
        //   DELETE NOTE FUNCTION
        // ==========================================

        /**
         * Delete the currently edited note after confirmation
         * Redirects to delete endpoint with note ID
         */
        function confirmDeleteNote() {
            if (!editingNoteId) return;  // Safety check
            
            if (confirm('Are you sure you want to delete this note?')) {
                window.location.href = '{{ url_for("handle_delete_note") }}?id=' + editingNoteId;
            }
        }

        // ==========================================
        //   EVENT LISTENERS
        // ==========================================

        // Close modal when clicking backdrop (outside modal content)
        document.getElementById('noteEditModal').addEventListener('click', function(clickEvent) {
            if (clickEvent.target === this) hideNoteModal();
        });

        // ==========================================
        //   TOAST NOTIFICATION
        // ==========================================

        const toastElement = document.getElementById('notificationToast');
        if (toastElement) {
            setTimeout(() => toastElement.classList.add('show'), 100);
            setTimeout(() => toastElement.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
