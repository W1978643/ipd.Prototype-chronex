<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ==== Document Meta & Resources ==== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks - Chronex</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- ==== Cosmic Background ==== -->
    <!-- Decorative fixed background elements creating space theme -->
    <div class="cosmic-background"></div>
    <div class="stars-decoration"></div>

    <!-- ==== Site Header ==== -->
    <!-- Fixed navigation bar present on all authenticated pages -->
    <header class="site-header">
        <a href="{{ url_for('show_dashboard') }}" class="site-logo">Chronex</a>
        <nav class="navigation-menu">
            <a href="{{ url_for('show_dashboard') }}" class="navigation-link">Dashboard</a>
            <a href="{{ url_for('show_tasks_page') }}" class="navigation-link active">Tasks</a>  <!-- Current page -->
            <a href="{{ url_for('show_notes_page') }}" class="navigation-link">Notes</a>
            <a href="{{ url_for('show_focus_page') }}" class="navigation-link">Focus</a>
            <a href="{{ url_for('show_budget_page') }}" class="navigation-link">Budget</a>
            <a href="{{ url_for('show_achievements_page') }}" class="navigation-link">Achievements</a>
        </nav>
        <div class="header-right-section">
            <span class="logged-in-username">{{ current_user.username }}</span>
            <a href="{{ url_for('show_settings_page') }}" class="navigation-link">Settings</a>
            <a href="{{ url_for('handle_logout') }}" class="navigation-link">Logout</a>
        </div>
    </header>

    <!-- ==== Main Content Area ==== -->
    <main class="page-content">
        <!-- Page Header with Add Task Button -->
        <div class="tasks-page-header">
            <div>
                <h1 class="page-title">Tasks & Calendar</h1>
                <p class="page-subtitle">Manage your tasks and schedule</p>
            </div>
            <button class="button button-primary" onclick="showAddTaskModal()">Add Task</button>
        </div>

        <!-- ==== Tab Navigation ==== -->
        <!-- Toggle between Tasks list and Calendar views -->
        <div class="tab-navigation">
            <div class="tab-button active" onclick="switchViewTab('tasks')">Tasks</div>
            <div class="tab-button" onclick="switchViewTab('calendar')">Calendar</div>
        </div>

        <!-- ==== Tasks List View ==== -->
        <!-- Default view showing all tasks in list format -->
        <div id="taskListPanel">
            <h3 class="card-heading">Active Tasks ({{ incomplete_tasks|length }})</h3>
            
            <!-- Loop through active (incomplete) tasks -->
            {% if incomplete_tasks %}
                {% for task in incomplete_tasks %}
                <div class="task-row" data-id="{{ task.id }}">
                    <!-- Checkbox - toggles task completion status -->
                    <input type="checkbox" class="task-complete-checkbox" onchange="toggleTaskCompletion({{ task.id }})">
                    
                    <!-- Task Details -->
                    <div class="task-details">
                        <div class="task-name">{{ task.task_title }}</div>
                        <!-- Date range display: start_date → deadline_date -->
                        <div class="task-date-info">
                            {% if task.start_date %}{{ task.start_date.strftime('%d %b') }}{% endif %}
                            {% if task.deadline_date %} → {{ task.deadline_date.strftime('%d %b') }}{% endif %}
                        </div>
                    </div>
                    
                    <!-- Priority Badge - color-coded (high=red, medium=yellow, low=green) -->
                    <span class="priority-badge priority-{{ task.priority_level }}-badge">{{ task.priority_level }}</span>
                    
                    <!-- Action Buttons -->
                    <div class="task-buttons">
                        <button class="button button-small button-secondary" onclick="showEditTaskModal({{ task.id }}, '{{ task.task_title }}', '{{ task.start_date }}', '{{ task.deadline_date }}', '{{ task.priority_level }}')">Edit</button>
                        <button class="button button-small button-danger" onclick="confirmDeleteTask({{ task.id }})">Delete</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State - shown when no active tasks exist -->
                <div class="empty-state-message">
                    <div class="empty-state-heading">No active tasks</div>
                    <p>Add a task to get started!</p>
                </div>
            {% endif %}

            <!-- ==== Completed Tasks Section ==== -->
            <!-- Only rendered if completed tasks exist -->
            {% if finished_tasks %}
            <h3 class="card-heading margin-top-medium">Completed ({{ finished_tasks|length }})</h3>
            {% for task in finished_tasks %}
            <div class="task-row task-completed">  <!-- .task-completed applies strikethrough styling -->
                <input type="checkbox" class="task-complete-checkbox" checked onchange="toggleTaskCompletion({{ task.id }})">
                <div class="task-details">
                    <div class="task-name">{{ task.task_title }}</div>
                </div>
                <button class="button button-small button-danger" onclick="confirmDeleteTask({{ task.id }})">Delete</button>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <!-- ==== Calendar View ==== -->
        <!-- 
            Hidden by default, shown when Calendar tab is clicked
            Displays monthly grid with tasks on their date ranges
        -->
        <div id="calendarViewPanel" style="display: none;">
            <div class="content-card">
                <!-- Month Navigation Controls -->
                <div class="calendar-navigation">
                    <button class="button button-small button-secondary" onclick="navigateCalendarMonth(-1)">Prev</button>
                    <span class="calendar-month-label" id="currentMonthLabel">January 2026</span>
                    <button class="button button-small button-secondary" onclick="navigateCalendarMonth(1)">Next</button>
                </div>
                
                <!-- Weekday Headers (Mon-Sun) -->
                <div class="calendar-weekday-headers">
                    <div class="calendar-weekday-label">Mon</div>
                    <div class="calendar-weekday-label">Tue</div>
                    <div class="calendar-weekday-label">Wed</div>
                    <div class="calendar-weekday-label">Thu</div>
                    <div class="calendar-weekday-label">Fri</div>
                    <div class="calendar-weekday-label">Sat</div>
                    <div class="calendar-weekday-label">Sun</div>
                </div>
                
                <!-- Calendar Grid - Populated dynamically by JavaScript -->
                <div class="calendar-day-grid" id="calendarDaysGrid"></div>
            </div>
        </div>
    </main>

    <!-- ==== Add/Edit Task Modal ==== -->
    <!-- 
        Reusable modal for both creating and editing tasks
        Form action URL changed dynamically by JavaScript
    -->
    <div class="modal-backdrop" id="taskEditModal">
        <div class="modal-window">
            <div class="modal-heading" id="taskModalHeading">Add New Task</div>
            <form id="taskDetailsForm" action="{{ url_for('handle_add_task') }}" method="POST">
                <!-- Hidden field stores task ID when editing -->
                <input type="hidden" name="task_id" id="taskIdHidden">
                
                <!-- Task Title Input -->
                <div class="input-group">
                    <label class="input-label">Task Title</label>
                    <input type="text" name="title" id="taskNameInput" class="text-input" placeholder="Enter task title" required>
                </div>
                
                <!-- Start Date - Custom day/month picker -->
                <div class="input-group">
                    <label class="input-label">From</label>
                    <div class="date-input-group">
                        <input type="text" id="startDayInput" class="text-input day-input" maxlength="2" placeholder="DD">
                        <select id="startMonthInput" class="dropdown-select month-select">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <!-- Hidden field - populated by JS with YYYY-MM-DD format -->
                    <input type="hidden" name="start_date" id="startDateHidden">
                </div>
                
                <!-- Deadline Date - Custom day/month picker -->
                <div class="input-group">
                    <label class="input-label">Due</label>
                    <div class="date-input-group">
                        <input type="text" id="deadlineDayInput" class="text-input day-input" maxlength="2" placeholder="DD">
                        <select id="deadlineMonthInput" class="dropdown-select month-select">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <input type="hidden" name="deadline_date" id="deadlineDateHidden">
                </div>
                
                <!-- Priority Selection Dropdown -->
                <div class="input-group">
                    <label class="input-label">Priority</label>
                    <select name="priority" id="taskPrioritySelect" class="dropdown-select">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <!-- Modal Action Buttons -->
                <div class="modal-buttons">
                    <button type="button" class="button button-secondary" onclick="hideTaskModal()">Cancel</button>
                    <button type="submit" class="button button-primary" id="saveTaskButton">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==== Flash Messages ==== -->
    <!-- Server-side notifications rendered by Jinja2 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="toast-notification {{ category }}" id="notificationToast">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ==== JavaScript ==== -->
    <script>
        // ==========================================
        //   DATA FROM SERVER
        // ==========================================

        // Task data passed from Flask as JSON for calendar rendering
        // Contains: id, title, start_date, deadline_date, priority
        const calendarTasksData = {{ calendar_tasks_data|tojson|safe }};
        
        // Current date string for highlighting today in calendar
        const currentDateString = '{{ current_date }}';
        
        // Calendar state - starts at CURRENT month (dynamic)
        const today = new Date();
        let selectedYear = today.getFullYear();
        let selectedMonth = today.getMonth();  // 0-indexed (0 = Jan, 1 = Feb, etc.)

        // ==========================================
        //   TAB SWITCHING
        // ==========================================

        /**
         * Toggle between Tasks list and Calendar views
         * @param {string} selectedTab - 'tasks' or 'calendar'
         */
        function switchViewTab(selectedTab) {
            // Show/hide panels based on selection
            document.getElementById('taskListPanel').style.display = selectedTab === 'tasks' ? 'block' : 'none';
            document.getElementById('calendarViewPanel').style.display = selectedTab === 'calendar' ? 'block' : 'none';
            
            // Update tab button active states
            document.querySelectorAll('.tab-button').forEach((tabButton, index) => {
                tabButton.classList.toggle('active', (selectedTab === 'tasks' && index === 0) || (selectedTab === 'calendar' && index === 1));
            });
            
            // Build calendar grid when switching to calendar view
            if (selectedTab === 'calendar') buildCalendarGrid();
        }

        // ==========================================
        //   MODAL FUNCTIONS
        // ==========================================

        /**
         * Open modal for adding a new task
         * Resets form and pre-fills with current date
         */
        function showAddTaskModal() {
            document.getElementById('taskModalHeading').textContent = 'Add New Task';
            document.getElementById('taskDetailsForm').action = '{{ url_for("handle_add_task") }}';
            document.getElementById('taskIdHidden').value = '';
            document.getElementById('taskNameInput').value = '';
            
            // Pre-fill with current date
            const currentDate = new Date();
            document.getElementById('startDayInput').value = currentDate.getDate();
            document.getElementById('startMonthInput').value = String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('deadlineDayInput').value = '';
            document.getElementById('deadlineMonthInput').value = String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('taskPrioritySelect').value = 'medium';
            document.getElementById('saveTaskButton').textContent = 'Add Task';
            
            document.getElementById('taskEditModal').classList.add('active');
        }

        /**
         * Open modal pre-filled for editing an existing task
         * @param {number} taskId - Task database ID
         * @param {string} taskTitle - Current task title
         * @param {string} startDate - Current start date (YYYY-MM-DD or 'None')
         * @param {string} deadlineDate - Current deadline date (YYYY-MM-DD or 'None')
         * @param {string} priorityLevel - Current priority (low/medium/high)
         */
        function showEditTaskModal(taskId, taskTitle, startDate, deadlineDate, priorityLevel) {
            document.getElementById('taskModalHeading').textContent = 'Edit Task';
            document.getElementById('taskDetailsForm').action = '{{ url_for("handle_update_task") }}';
            document.getElementById('taskIdHidden').value = taskId;
            document.getElementById('taskNameInput').value = taskTitle;
            
            // Parse and fill date fields if dates exist
            if (startDate && startDate !== 'None') {
                const [year, month, day] = startDate.split('-');
                document.getElementById('startDayInput').value = parseInt(day);
                document.getElementById('startMonthInput').value = month;
            }
            if (deadlineDate && deadlineDate !== 'None') {
                const [year, month, day] = deadlineDate.split('-');
                document.getElementById('deadlineDayInput').value = parseInt(day);
                document.getElementById('deadlineMonthInput').value = month;
            }
            
            document.getElementById('taskPrioritySelect').value = priorityLevel;
            document.getElementById('saveTaskButton').textContent = 'Update Task';
            document.getElementById('taskEditModal').classList.add('active');
        }

        /**
         * Hide the task modal
         */
        function hideTaskModal() {
            document.getElementById('taskEditModal').classList.remove('active');
        }

        // Close modal when clicking outside (on backdrop)
        document.getElementById('taskEditModal').addEventListener('click', function(clickEvent) {
            if (clickEvent.target === this) hideTaskModal();
        });

        // ==========================================
        //   FORM SUBMISSION
        // ==========================================

        /**
         * Combine day/month fields into YYYY-MM-DD format before form submit
         * Hidden fields are sent to server, visible fields are for UX only
         */
        document.getElementById('taskDetailsForm').addEventListener('submit', function() {
            // Process start date
            const startDay = document.getElementById('startDayInput').value;
            const startMonth = document.getElementById('startMonthInput').value;
            if (startDay) {
                document.getElementById('startDateHidden').value = `2026-${startMonth}-${String(startDay).padStart(2, '0')}`;
            }
            
            // Process deadline date
            const deadlineDay = document.getElementById('deadlineDayInput').value;
            const deadlineMonth = document.getElementById('deadlineMonthInput').value;
            if (deadlineDay) {
                document.getElementById('deadlineDateHidden').value = `2026-${deadlineMonth}-${String(deadlineDay).padStart(2, '0')}`;
            }
        });

        // ==========================================
        //   TASK ACTIONS
        // ==========================================

        /**
         * Toggle task completion status
         * Redirects to server endpoint which toggles and redirects back
         * @param {number} taskId - Task database ID
         */
        function toggleTaskCompletion(taskId) {
            window.location.href = '/task/toggle?id=' + taskId;
        }

        /**
         * Delete a task after confirmation
         * @param {number} taskId - Task database ID
         */
        function confirmDeleteTask(taskId) {
            if (confirm('Delete this task?')) {
                window.location.href = '/task/delete?id=' + taskId;
            }
        }

        // ==========================================
        //   CALENDAR RENDERING
        // ==========================================

        /**
         * Navigate between months
         * @param {number} direction - -1 for previous, +1 for next
         */
        function navigateCalendarMonth(direction) {
            selectedMonth += direction;
            // Handle year rollover
            if (selectedMonth > 11) { selectedMonth = 0; selectedYear++; }
            if (selectedMonth < 0) { selectedMonth = 11; selectedYear--; }
            buildCalendarGrid();
        }

        /**
         * Build the calendar grid dynamically
         * Creates day cells and populates with tasks that span each date
         */
        function buildCalendarGrid() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update month label
            document.getElementById('currentMonthLabel').textContent = `${monthNames[selectedMonth]} ${selectedYear}`;
            
            // Calculate calendar layout
            const firstDayOfMonth = new Date(selectedYear, selectedMonth, 1).getDay();
            const totalDaysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            const startingWeekday = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;  // Adjust for Monday start
            
            let calendarHtml = '';
            
            // Generate empty cells for days before month starts
            for (let i = 0; i < startingWeekday; i++) {
                calendarHtml += '<div class="calendar-day-cell calendar-empty-cell"></div>';
            }
            
            // Generate cell for each day of the month
            for (let dayNumber = 1; dayNumber <= totalDaysInMonth; dayNumber++) {
                const cellDateString = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                const isTodayClass = cellDateString === currentDateString ? ' calendar-today' : '';
                
                // Filter tasks that span this date (between start_date and deadline_date)
                const tasksForThisDay = calendarTasksData.filter(task => {
                    const taskStart = task.start_date;
                    const taskDeadline = task.deadline_date || task.start_date;
                    return taskStart && cellDateString >= taskStart && cellDateString <= taskDeadline;
                });
                
                // Build day cell HTML
                calendarHtml += `<div class="calendar-day-cell${isTodayClass}">`;
                calendarHtml += `<div class="calendar-day-number">${dayNumber}</div>`;
                calendarHtml += '<div class="calendar-day-tasks">';
                
                // Show up to 2 tasks as chips, then overflow indicator
                tasksForThisDay.slice(0, 2).forEach(task => {
                    calendarHtml += `<div class="calendar-task-chip priority-${task.priority}-badge" onclick="showEditTaskModal(${task.id}, '${task.title}', '${task.start_date}', '${task.deadline_date}', '${task.priority}')">${task.title}</div>`;
                });
                
                // Show "+N more" if more than 2 tasks
                if (tasksForThisDay.length > 2) {
                    calendarHtml += `<div class="calendar-overflow-indicator">+${tasksForThisDay.length - 2} more</div>`;
                }
                
                calendarHtml += '</div></div>';
            }
            
            // Insert generated HTML into calendar grid
            document.getElementById('calendarDaysGrid').innerHTML = calendarHtml;
        }

        // ==========================================
        //   TOAST NOTIFICATION
        // ==========================================

        // Auto-show and hide flash messages
        const toastElement = document.getElementById('notificationToast');
        if (toastElement) {
            setTimeout(() => toastElement.classList.add('show'), 100);
            setTimeout(() => toastElement.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
